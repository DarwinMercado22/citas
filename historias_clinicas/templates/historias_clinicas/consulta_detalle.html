{% extends 'base.html' %}

{% block title %}Detalle de Consulta - Sistema Hospital{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-clipboard2-pulse"></i> Detalle de Consulta</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'historia_clinica_detalle' paciente.pk %}">Historia Clínica</a></li>
                    <li class="breadcrumb-item active">Consulta</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                {% if user.rol == 'MEDICO' or user.rol == 'ADMIN' %}
                <a href="{% url 'consulta_editar' consulta.pk %}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Editar
                </a>
                <a href="{% url 'examen_crear' consulta.pk %}" class="btn btn-success">
                    <i class="bi bi-clipboard-data"></i> Agregar Examen
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Info del Paciente -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-badge"></i> Información del Paciente</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Paciente:</strong> {{ paciente.get_nombre_completo }}
                </div>
                <div class="col-md-4">
                    <strong>Edad:</strong> {{ paciente.get_edad }} años
                </div>
                <div class="col-md-4">
                    <strong>Tipo de Sangre:</strong> <span class="badge bg-danger">{{ paciente.tipo_sangre }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Información de la Consulta -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información de la Consulta</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Fecha:</strong> {{ consulta.fecha_consulta|date:"d/m/Y H:i" }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Médico:</strong> Dr. {{ consulta.medico.get_full_name }}
                    {% if consulta.medico.especialidad %}
                        ({{ consulta.medico.especialidad }})
                    {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Signos Vitales -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> Signos Vitales</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% if consulta.presion_arterial %}
                <div class="col-md-3 mb-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Presión Arterial</h6>
                            <h4 class="card-title">{{ consulta.presion_arterial }}</h4>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if consulta.frecuencia_cardiaca %}
                <div class="col-md-3 mb-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Frecuencia Cardíaca</h6>
                            <h4 class="card-title">{{ consulta.frecuencia_cardiaca }} <small>ppm</small></h4>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if consulta.temperatura %}
                <div class="col-md-2 mb-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Temperatura</h6>
                            <h4 class="card-title">{{ consulta.temperatura }} <small>°C</small></h4>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if consulta.peso %}
                <div class="col-md-2 mb-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Peso</h6>
                            <h4 class="card-title">{{ consulta.peso }} <small>kg</small></h4>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if consulta.altura %}
                <div class="col-md-2 mb-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Altura</h6>
                            <h4 class="card-title">{{ consulta.altura }} <small>cm</small></h4>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Detalles de la Consulta -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning">
                    <h6 class="mb-0"><i class="bi bi-clipboard"></i> Motivo de Consulta</h6>
                </div>
                <div class="card-body">
                    <p>{{ consulta.motivo_consulta }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning">
                    <h6 class="mb-0"><i class="bi bi-thermometer"></i> Síntomas</h6>
                </div>
                <div class="card-body">
                    <p>{{ consulta.sintomas }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="bi bi-file-medical"></i> Diagnóstico</h6>
                </div>
                <div class="card-body">
                    <p>{{ consulta.diagnostico }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-capsule"></i> Tratamiento</h6>
                </div>
                <div class="card-body">
                    <p>{{ consulta.tratamiento }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if consulta.observaciones %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Observaciones</h6>
        </div>
        <div class="card-body">
            <p>{{ consulta.observaciones }}</p>
        </div>
    </div>
    {% endif %}

    {% if consulta.proxima_cita %}
    <div class="alert alert-info">
        <i class="bi bi-calendar-check"></i> 
        <strong>Próxima Cita:</strong> {{ consulta.proxima_cita|date:"d/m/Y" }}
    </div>
    {% endif %}

    <!-- Exámenes -->
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Exámenes</h5>
            {% if user.rol == 'MEDICO' %}
            <a href="{% url 'examen_crear' consulta.pk %}" class="btn btn-light btn-sm">
                <i class="bi bi-plus-circle"></i> Agregar Examen
            </a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if examenes %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Tipo</th>
                                <th>Nombre</th>
                                <th>Fecha Solicitud</th>
                                <th>Fecha Realización</th>
                                <th>Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for examen in examenes %}
                            <tr>
                                <td><span class="badge bg-info">{{ examen.get_tipo_display }}</span></td>
                                <td><strong>{{ examen.nombre }}</strong></td>
                                <td>{{ examen.fecha_solicitud|date:"d/m/Y" }}</td>
                                <td>
                                    {% if examen.fecha_realizacion %}
                                        {{ examen.fecha_realizacion|date:"d/m/Y" }}
                                    {% else %}
                                        <span class="text-muted">Pendiente</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if examen.resultados %}
                                        <span class="badge bg-success">Completado</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'examen_editar' examen.pk %}" class="btn btn-outline-primary" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% if examen.archivo_resultado %}
                                        <a href="{{ examen.archivo_resultado.url }}" class="btn btn-outline-success" title="Descargar" target="_blank">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        {% endif %}
                                        <a href="{% url 'examen_eliminar' examen.pk %}" class="btn btn-outline-danger" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-clipboard-x" style="font-size: 2rem;"></i>
                    <p class="mt-2">No hay exámenes registrados para esta consulta</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}